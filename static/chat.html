<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chat</title>
</head>

<body>
    <select id="models" disabled></select>
    <div id="messages"></div>
    <textarea id="prompt" rows="4" disabled></textarea>
    <input id="files" type="file" multiple accept="image/*,.pdf" disabled>
    <input id="stream" type="checkbox" checked disabled>
    <button id="send" disabled>Send</button>

    <script>
        const API_URL = "/api-v1";

        let models = [];
        let dialog = {
            completions: []
        }

        let model = "anthropic/claude-sonnet-4";
        let stream = true;

        // interface
        const modelsElement = document.getElementById("models");
        const messagesElement = document.getElementById("messages");
        const promptElement = document.getElementById("prompt");
        const filesElement = document.getElementById("files");
        const streamElement = document.getElementById("stream");
        const sendButton = document.getElementById("send");

        function onModelChange(event) {
            model = event.target.value;
            // ...
        }

        function onPromptInput(event) {
            const prompt = event.target.value;
            sendButton.disabled = !prompt.trim();
        }

        function onPromptKeyDown(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                if (!sendButton.disabled) {
                    sendButton.click();
                }
            }
        }

        function onStreamChange(event) {
            stream = event.target.checked;
        }

        // chat/completions
        function readText() {
            const value = promptElement.value;
            const text = value.trim();
            if (!text) {
                throw new Error();
            }
            return text;
        }

        async function readFiles() {
            let files = [];
            for (const file of filesElement.files) {
                if (file.type.startsWith("image/") || file.type == "application/pdf") {
                    try {
                        const data = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = function (event) {
                                resolve(event.target.result);
                            };
                            reader.onerror = function (event) {
                                reject();
                            };
                            reader.readAsDataURL(file);
                        });
                        if (data) {
                            files.push({
                                type: file.type,
                                name: file.name,
                                data: data
                            });
                        } else {
                            console.warn(file);
                        }
                    } catch (error) {
                        console.error(error);
                    }
                } else {
                    console.warn(file.type);
                    continue;
                }
            }
            return files;
        }

        async function complete() {
            sendButton.disabled = true;
            try {
                let text = readText();
                let files = await readFiles();

                let content;
                if (files.length > 0) {
                    content = [];
                    for (const file of files) {
                        if (file.type.startsWith("image/")) {
                            content.push({
                                type: "image_url",
                                image_url: {
                                    url: file.data,
                                }
                            });
                        }
                        else if (file.type === "application/pdf") {
                            content.push({
                                type: "file",
                                file: {
                                    file_data: file.data,
                                    filename: file.name
                                }
                            });
                        }
                    };
                    content.push({
                        type: "text",
                        text: text
                    });
                } else {
                    content = text;
                }
                let messages = [];
                if (dialog.completions.length > 0) {
                    messages = dialog.completions[dialog.completions.length - 1].body.messages;
                }
                messages.push({
                    role: "user",
                    content: content
                });
                let completion = {
                    body: { model, stream, messages },
                    chunks: [],
                };

                let message = {
                    role: "assistant",
                    content: "",
                };
                const response = await fetch(`${API_URL}/chat/completions`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(completion.body)
                });
                if (response.headers.get("content-type")?.startsWith("text/event-stream")) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let stop = false;
                    while (!stop) {
                        const { value, done } = await reader.read();
                        if (done) {
                            stop = true;
                        }
                        const chunk = decoder.decode(value, { stream: true });
                        completion.chunks.push(chunk);
                        // rerender
                        if (stop) {
                            break;
                        }
                    }
                    for (let i = 0; i < completion.chunks.length; i++) {
                        const chunk = completion.chunks[i];
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                const dataString = line.slice(5).trim();
                                if (dataString == '[DONE]') {
                                    continue;
                                }
                                const data = JSON.parse(dataString);
                                if (data && data.choices && data.choices.length > 0) {
                                    for (let j = 0; j < data.choices.length; j++) {
                                        if (j > 0) {
                                            console.warn(j);
                                        }
                                        if (data.choices[j]?.delta?.content) {
                                            message.content += data.choices[j].delta.content;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    completion.body.messages.push(message);
                    dialog.completions.push(completion);
                } else {
                    const data = await response.json();
                    if (response.ok && data && data.choices && data.choices.length > 0) {
                        for (let i = 0; i < data.choices.length; i++) {
                            if (i > 0) {
                                console.warn(i);
                            }
                            message.content += data.choices[i].message.content;
                        }
                        completion.body.messages.push(message);
                        dialog.completions.push(completion);
                    } else {
                        throw new Error();
                    }
                }
                // clear input
                promptElement.value = "";
                filesElement.value = "";
                sendButton.disabled = false;
                // render messages
                console.log(dialog);
                const messageDiv = document.createElement("div");
                messageDiv.className = "message";
                messageDiv.innerHTML = `<strong>User:</strong> ${text}<br>`;
                if (files.length > 0) {
                    for (const file of files) {
                        if (file.type.startsWith("image/")) {
                            const img = document.createElement("img");
                            img.src = file.data;
                            img.alt = file.name;
                            img.style.maxWidth = "100%";
                            messageDiv.appendChild(img);
                        } else if (file.type === "application/pdf") {
                            const link = document.createElement("a");
                            link.href = file.data;
                            link.textContent = file.name;
                            link.target = "_blank";
                            messageDiv.appendChild(link);
                        }
                    }
                }
                messagesElement.appendChild(messageDiv);
                const assistantDiv = document.createElement("div");
                assistantDiv.className = "message assistant";
                assistantDiv.innerHTML = `<strong>Assistant:</strong> ${message.content}`;
                messagesElement.appendChild(assistantDiv);
                messagesElement.scrollTop = messagesElement.scrollHeight;
            } catch (error) {
                console.error(error);
            }
        }

        // models
        async function fetchModels() {
            const modelsResponse = await fetch(`${API_URL}/models`);
            modelsJson = await modelsResponse.json();
            return modelsJson.data;
        }

        function renderModels(value) {
            modelsElement.innerHTML = "";
            for (const model of models) {
                const option = document.createElement("option");
                option.value = model.id;
                option.textContent = model.name;
                option.title = model.description;
                modelsElement.appendChild(option);
            }
            if (value && models.some(model => model.id == value)) {
                modelsElement.value = value;
            }
        }

        async function initialize() {
            modelsElement.addEventListener("change", onModelChange);
            promptElement.addEventListener("input", onPromptInput);
            promptElement.addEventListener("keydown", onPromptKeyDown);
            streamElement.addEventListener("change", onStreamChange);
            sendButton.addEventListener("click", complete);
            try {
                models = await fetchModels();
                renderModels(model);
                modelsElement.disabled = false;
                promptElement.disabled = false;
                filesElement.disabled = false;
                streamElement.disabled = false;
                sendButton.disabled = false;
            } catch (error) {
                console.error(error);
            }
        }

        window.addEventListener("load", initialize);
    </script>
</body>

</html>